<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard ‚Äî Products</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="mobile-toggle" onclick="toggleSidebar()">‚ò∞ Menu</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="brand"><div class="logo">ADM</div><div><strong>Admin</strong><div style="font-size:12px;color:var(--muted)">Dashboard</div></div></div>
  <div class="menu-item active" onclick="goTo('products')">‚ûï Products Add</div>
  <div class="menu-item" onclick="goTo('orders')">üìù Work Orders</div><div class="menu-item" onclick="goTo('stock')">üìã stock</div>
  <div style="height:1px;background:#eef2f7;margin:12px 0;border-radius:8px"></div>
  <div style="font-size:13px;color:var(--muted)">Logged in as <b style="color:var(--text)">Admin</b></div>
  <div style="margin-top:10px">
    <button style="margin-top:8px;width:100%;padding:10px;border-radius:8px;border:none;background:#f3f7ff;color:var(--primary);cursor:pointer" onclick="logout()">Logout</button>
  </div>
</div>

<!-- Main -->
<div class="main">
  <div class="container">
    <!-- LEFT: Add / Edit form -->
    <div class="card">
      <h3 id="formTitle">Add Product</h3>

      <div class="form-row"><input id="pname" placeholder="Product Name *"></div>
      <div class="form-row"><input id="price" type="number" placeholder="Price ($) *"></div>
      <div class="form-row"><input id="discount" type="number" placeholder="Discount (%)"></div>
      <div class="form-row"><input id="stockQty" type="number" placeholder="Stock Quantity *"></div>
      <div class="form-row"><input id="category" placeholder="Category"></div>

      <div class="form-row">
        <label style="display:block;margin-bottom:6px">Image Source</label>
        <select id="imgSource" onchange="toggleImageInput()">
          <option value="url">URL</option>
          <option value="file">Upload</option>
        </select>
      </div>

      <div class="form-row"><input id="imgUrl" placeholder="https://example.com/image.jpg"></div>
      <div class="form-row" style="display:none" id="imgFileRow"><input id="imgFile" type="file" accept="image/*"></div>

      <div class="form-row"><textarea id="desc" rows="4" placeholder="Description"></textarea></div>
      <div class="form-row"><input id="videoUrl" placeholder="Video URL"></div>

      <div style="display:flex; gap:10px">
        <button onclick="saveProduct()" style="flex:1;background:var(--primary);color:#fff">Save Product</button>
        <button onclick="clearForm()" style="flex:1;background:#f3f7ff;color:var(--primary)">Clear</button>
      </div>

      <div style="margin-top:12px; font-size:13px; color:var(--muted)">* Required fields: Name, Price, Stock</div>
    </div>
    </div>
    </div>

<script type="module">
/* ===== Firebase + app setup (modular SDK) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

/* ---------- Paste your firebaseConfig here ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCAU5ecL2IJypUmkXwVbt7f-wV-pdKkY9U",
  authDomain: "shophut-a5f7f.firebaseapp.com",
  projectId: "shophut-a5f7f",
  storageBucket: "shophut-a5f7f.firebasestorage.app",
  messagingSenderId: "767008652056",
  appId: "1:767008652056:web:1a4ed7feae55a31a533c6d",
  measurementId: "G-M1G44X839C"
};
/* --------------------------------------------------- */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

//////////////////////
// Auth protection
//////////////////////
let currentUser = null;
onAuthStateChanged(auth, user => {
  currentUser = user;
  if (!user) {
    // If not logged in, redirect to login.html (same as before)
    window.location.href = 'login.html';
  } else {
    // page ok ‚Äî start listeners
    startRealtimeListeners();
  }
});

/* ====== Keep same function names and behavior, but backed by Firestore ====== */

/* ====== App State ====== */
let editIndex = -1;        // used by UI (keeps index style, but we track editId separately)
let editId = null;         // Firestore doc id when editing
let productsSnapshot = []; // cached array of products from Firestore (each item has .id and fields)

/* Collections */
const productsCol = collection(db, 'products');
const ordersCol = collection(db, 'orders');

/* ====== Utility helpers ====== */
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function formatMoney(n){ return Number(n||0).toFixed(2); }

/* ====== Backwards-compatible API: getProducts / setProducts (but using Firestore) ====== */
/* getProducts() used elsewhere in your UI ‚Äî return local array snapshot to avoid breaking calls */
function getProducts(){
  return productsSnapshot.map(p => ({ ...p })); // shallow copy
}
window.getProducts = getProducts; // expose globally in case other inline handlers call it

/* setProducts(arr) ‚Äî not used in Firestore world; we'll keep a stub to avoid errors */
function setProducts(arr){
  // noop: Firestore is source of truth. If you really want to overwrite collection, we can implement,
  // but that's risky. Keep stub to preserve compatibility.
  console.warn('setProducts called ‚Äî this operation is disabled in Firestore mode.');
}
window.setProducts = setProducts;

/* ====== Category filter & render (uses productsSnapshot) ====== */
function buildCategoryFilter(){
  const sel = document.getElementById('categoryFilter');
  if(!sel) return;
  const cats = Array.from(new Set(productsSnapshot.map(p => p.category || 'Uncategorized')));
  const cur = sel.value || 'all';
  sel.innerHTML = '<option value="all">All categories</option>';
  cats.forEach(c => sel.appendChild(new Option(c, c)));
  if(Array.from(sel.options).some(o => o.value === cur)) sel.value = cur;
}
window.buildCategoryFilter = buildCategoryFilter;

function renderProducts(){
  // This matches your previous UI: find productTable or stockTable
  const all = getProducts();
  const search = document.getElementById('searchInput') ? document.getElementById('searchInput').value.trim().toLowerCase() : '';
  const category = document.getElementById('categoryFilter') ? document.getElementById('categoryFilter').value : 'all';

  const filtered = all.filter(p =>
    (category === 'all' || (p.category || 'Uncategorized') === category) &&
    (!search || (p.name || '').toLowerCase().includes(search) || ((p.desc||'').toLowerCase().includes(search)))
  );

  const tbody = document.getElementById('productTable') || document.getElementById('stockTable');
  if (!tbody) return;
  tbody.innerHTML = '';

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8" style="color:var(--muted)">No products found</td></tr>`;
    return;
  }

  filtered.forEach(p => {
    const finalPrice = Number(p.price) * (1 - (p.discount || 0) / 100);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img class="product-image" src="${p.image || 'https://via.placeholder.com/120x90?text=No+Image'}"></td>
      <td><strong>${escapeHtml(p.name)}</strong><div style="font-size:12px;color:var(--muted)">${escapeHtml(p.desc||'')}</div></td>
      <td>${escapeHtml(p.category || 'Uncategorized')}</td>
      <td>${p.stock || 0}</td>
      <td>$${Number(p.price || 0).toFixed(2)}</td>
      <td>${p.discount || 0}%</td>
      <td>$${(isFinite(finalPrice) ? finalPrice : 0).toFixed(2)}</td>
      <td class="row-actions">
        <button class="page-btn" onclick="startEdit('${p.id}')">Edit</button>
        <button class="page-btn" onclick="deleteProduct('${p.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  const totalSpan = document.getElementById('totalCount');
  if (totalSpan) totalSpan.textContent = filtered.length;
}
window.renderProducts = renderProducts;

/* ====== Image helpers (uploads to Storage) ====== */
async function uploadImageFile(file){
  if(!file) return { url: '', path: '' };
  const path = `product_images/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
  const ref = storageRef(storage, path);
  const snap = await uploadBytes(ref, file);
  const url = await getDownloadURL(snap.ref);
  return { url, path };
}

/* ====== Save Product (add / update) ====== */
window.saveProduct = async function(){
  const name = document.getElementById('pname').value.trim();
  const price = Number(document.getElementById('price').value || 0);
  const discount = Number(document.getElementById('discount').value || 0);
  const stockQty = parseInt(document.getElementById('stockQty').value || 0, 10);
  const category = document.getElementById('category').value.trim() || 'Uncategorized';
  const desc = document.getElementById('desc').value.trim();
  const videoUrl = document.getElementById('videoUrl') ? document.getElementById('videoUrl').value.trim() : '';

  if(!name || !price || !Number.isFinite(stockQty)){
    alert('Please fill required fields: Name, Price, Stock');
    return;
  }

  const imgSourceEl = document.getElementById('imgSource');
  const imgSource = imgSourceEl ? imgSourceEl.value : 'url';
  const imgUrlInput = document.getElementById('imgUrl');
  const fileInput = document.getElementById('imgFile');

  try{
    if(editId){
      // update existing doc
      const docRef = doc(db, 'products', editId);
      const updateData = {
        name, price, discount, stock: stockQty, category, desc, videoUrl, updatedAt: Date.now()
      };

      if(imgSource === 'url' && imgUrlInput && imgUrlInput.value.trim()){
        // If user provided a URL, set it and remove prior imagePath if any
        updateData.image = imgUrlInput.value.trim();
        updateData.imagePath = '';
      } else if(imgSource === 'file' && fileInput && fileInput.files[0]){
        // upload new file
        const { url, path } = await uploadImageFile(fileInput.files[0]);
        updateData.image = url;
        updateData.imagePath = path;
      }
      await updateDoc(docRef, updateData);
      alert('Product updated successfully');
    } else {
      // add new doc
      const data = { name, price, discount, stock: stockQty, category, desc, videoUrl, createdAt: Date.now() };
      if(imgSource === 'url' && imgUrlInput && imgUrlInput.value.trim()){
        data.image = imgUrlInput.value.trim();
        data.imagePath = '';
      } else if(imgSource === 'file' && fileInput && fileInput.files[0]){
        const { url, path } = await uploadImageFile(fileInput.files[0]);
        data.image = url;
        data.imagePath = path;
      } else {
        data.image = '';
        data.imagePath = '';
      }
      await addDoc(productsCol, data);
      alert('Product added successfully');
    }

    // clear form + UI update will be handled by realtime listener
    clearForm();
  } catch(err){
    console.error(err);
    alert('Save error: ' + (err.message || err));
  }
};

/* ====== clearForm (keeps same UI behavior) ====== */
window.clearForm = function(){
  editIndex = -1;
  editId = null;
  const titleEl = document.getElementById('formTitle');
  if(titleEl) titleEl.innerText = 'Add Product';
  ['pname','price','discount','stockQty','category','imgUrl','desc','videoUrl'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = '';
  });
  if(document.getElementById('imgSource')) document.getElementById('imgSource').value = 'url';
  toggleImageInput();
  const f = document.getElementById('imgFile');
  if(f) f.value = '';
};
window.clearForm = window.clearForm;

/* ====== toggleImageInput (keeps same UI) ====== */
window.toggleImageInput = function() {
  const srcEl = document.getElementById('imgSource');
  if(!srcEl) return;
  const src = srcEl.value;
  const fileRow = document.getElementById('imgFileRow');
  const urlInput = document.getElementById('imgUrl');
  if(fileRow) fileRow.style.display = src === 'file' ? 'block' : 'none';
  if(urlInput) urlInput.style.display = src === 'url' ? 'block' : 'none';
};
window.toggleImageInput = window.toggleImageInput;

/* ====== startEdit (loads doc into form) ====== */
window.startEdit = async function(id){
  try{
    const d = await getDoc(doc(db, 'products', id));
    if(!d.exists()){
      alert('Product not found');
      return;
    }
    const p = d.data();
    editId = id;
    editIndex = -1;
    const titleEl = document.getElementById('formTitle');
    if(titleEl) titleEl.innerText = 'Edit Product';
    if(document.getElementById('pname')) document.getElementById('pname').value = p.name || '';
    if(document.getElementById('price')) document.getElementById('price').value = p.price || '';
    if(document.getElementById('discount')) document.getElementById('discount').value = p.discount || '';
    if(document.getElementById('stockQty')) document.getElementById('stockQty').value = p.stock || '';
    if(document.getElementById('category')) document.getElementById('category').value = p.category || '';
    if(document.getElementById('imgSource')) document.getElementById('imgSource').value = (p.image && !p.imagePath) ? 'url' : 'file';
    if(document.getElementById('imgUrl')) document.getElementById('imgUrl').value = (p.image && !p.imagePath) ? p.image : '';
    if(document.getElementById('desc')) document.getElementById('desc').value = p.desc || '';
    if(document.getElementById('videoUrl')) document.getElementById('videoUrl').value = p.videoUrl || '';
    const f = document.getElementById('imgFile'); if(f) f.value = '';
    toggleImageInput();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch(err){
    console.error(err);
    alert('Load error: ' + (err.message || err));
  }
};

/* ====== deleteProduct (deletes doc; deletes storage file if we have imagePath) ====== */
window.deleteProduct = async function(id){
  if(!confirm('Delete this product?')) return;
  try{
    const dref = doc(db, 'products', id);
    const d = await getDoc(dref);
    if(d.exists()){
      const p = d.data();
      // delete storage object if imagePath exists
      if(p.imagePath){
        try{
          const sRef = storageRef(storage, p.imagePath);
          await deleteObject(sRef);
        } catch(err){
          // don't block deletion if storage delete fails
          console.warn('Failed to delete storage object:', err);
        }
      }
    }
    await deleteDoc(dref);
    // realtime listener will refresh UI
  } catch(err){
    console.error(err);
    alert('Delete error: ' + (err.message || err));
  }
};

/* ====== Orders: migrate localStorage order functions to Firestore ====== */
/* getOrders()/setOrders() used in your code ‚Äî we'll implement Firestore-backed versions */

async function fetchOrdersArray(){
  // fetch all orders ordered by createdAt desc
  const q = query(ordersCol, orderBy('createdAt','desc'));
  const snap = await getDocs(q);
  const arr = [];
  snap.forEach(s => arr.push({ id: s.id, ...s.data() }));
  return arr;
}

window.getOrders = async function(){
  // keep compatibility: return a Promise resolving to array
  return await fetchOrdersArray();
};

window.setOrders = function(arr){
  // not supporting direct overwrite in Firestore mode
  console.warn('setOrders called ‚Äî disabled in Firestore mode.');
};

/* renderOrders: loads from Firestore and renders into #ordersTable */
window.renderOrders = async function(){
  const table = document.getElementById("ordersTable");
  if(!table) return;
  table.innerHTML = '';
  try{
    const orders = await fetchOrdersArray();
    if(orders.length === 0){
      table.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">No orders yet</td></tr>`;
      return;
    }
    orders.forEach(order => {
      let productsHtml = "";
      (order.items || []).forEach(p => {
        productsHtml += `
          <div>
            ${escapeHtml(p.name)} √ó ${p.qty}
            <span style="color:var(--muted);font-size:12px">($${Number(p.price||0).toFixed(2)})</span>
          </div>`;
      });
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>#${escapeHtml(order.id)}</td>
        <td>${escapeHtml(order.name || '')}<br><span style="font-size:12px;color:var(--muted)">${escapeHtml(order.phone || '')}</span></td>
        <td>${productsHtml}</td>
        <td>$${Number(order.total||0).toFixed(2)}</td>
        <td>${escapeHtml(order.status || '')}</td>
        <td>
          <button onclick="updateOrderStatus('${order.id}', 'Done')" class="page-btn">Done</button>
          <button onclick="deleteOrder('${order.id}')" class="page-btn">Delete</button>
        </td>
      `;
      table.appendChild(tr);
    });
  } catch(err){
    console.error(err);
    table.innerHTML = `<tr><td colspan="6" style="color:var(--muted)">Failed to load orders</td></tr>`;
  }
};

/* updateOrderStatus and deleteOrder ‚Äî operate on Firestore document with id = order id */
window.updateOrderStatus = async function(id, status){
  try{
    // order documents may use custom id field; here we assume order doc id equals order.id used previously
    // if your order documents used different id field, adapt accordingly.
    const ref = doc(db, 'orders', id);
    await updateDoc(ref, { status });
    // refresh
    await window.renderOrders();
  } catch(err){
    console.error(err);
    alert('Update order error: ' + (err.message || err));
  }
};

window.deleteOrder = async function(id){
  if(!confirm('Delete this order?')) return;
  try{
    await deleteDoc(doc(db, 'orders', id));
    await window.renderOrders();
  } catch(err){
    console.error(err);
    alert('Delete order error: ' + (err.message || err));
  }
};

/* ====== Real-time listeners (products) ====== */
let productsUnsub = null;
function startRealtimeListeners(){
  // products real-time
  if(productsUnsub) productsUnsub();
  const q = query(productsCol, orderBy('createdAt','desc'));
  productsUnsub = onSnapshot(q, snap => {
    const arr = [];
    snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
    productsSnapshot = arr;
    buildCategoryFilter();
    renderProducts();
  }, err => {
    console.error('Products snapshot error:', err);
  });

  // If you want orders realtime too, you can add a snapshot listener here.
  // For now admin opens Orders tab and calls renderOrders() which fetches orders once.
}

/* ====== Navigation, logout, sidebar helpers (preserve previous behavior) ====== */
window.goTo = function(page, event){
  document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
  if(event && event.target) event.target.classList.add('active');

  const main = document.querySelector('.main');
  if(!main) return;

  if(page === 'products'){
    // rebuild the products view using the same innerHTML you had ‚Äî product listener will fill table
    main.innerHTML = `
      <div class="header">
  <div class="container">
    <!-- LEFT: Add / Edit form -->
    <div class="card">
      <h3 id="formTitle">Add Product</h3>

      <div class="form-row"><input id="pname" placeholder="Product Name *"></div>
      <div class="form-row"><input id="price" type="number" placeholder="Price ($) *"></div>
      <div class="form-row"><input id="discount" type="number" placeholder="Discount (%)"></div>
      <div class="form-row"><input id="stockQty" type="number" placeholder="Stock Quantity *"></div>
      <div class="form-row"><input id="category" placeholder="Category"></div>

      <div class="form-row">
        <label style="display:block;margin-bottom:6px">Image Source</label>
        <select id="imgSource" onchange="toggleImageInput()">
          <option value="url">URL</option>
          <option value="file">Upload</option>
        </select>
      </div>

      <div class="form-row"><input id="imgUrl" placeholder="https://example.com/image.jpg"></div>
      <div class="form-row" style="display:none" id="imgFileRow"><input id="imgFile" type="file" accept="image/*"></div>

      <div class="form-row"><textarea id="desc" rows="4" placeholder="Description"></textarea></div>
      <div class="form-row"><input id="videoUrl" placeholder="Video URL"></div>

      <div style="display:flex; gap:10px">
        <button onclick="saveProduct()" style="flex:1;background:var(--primary);color:#fff">Save Product</button>
        <button onclick="clearForm()" style="flex:1;background:#f3f7ff;color:var(--primary)">Clear</button>
      </div>

      <div style="margin-top:12px; font-size:13px; color:var(--muted)">* Required fields: Name, Price, Stock</div>
    </div>
    </div>
    </div>
`;
  } else if(page === 'orders'){
    main.innerHTML = `
      <div class="header"><h1>Orders Management</h1></div>
      <div class="card">
        <table>
          <thead><tr><th>Order ID</th><th>Customer</th><th>Products</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </div>`;
    // fetch and render orders
    window.renderOrders();
  } else if(page === 'stock'){
    main.innerHTML = `
      <div class="header"><h1>Stock Management</h1>
<div class="controls">
  <input id="searchInput" placeholder="Search products..." oninput="onFilterChange()" />
      </div>
      <select id="categoryFilter" onchange="onFilterChange()">
        <option value="all">All categories</option>
        </select>
        </div>
      <div class="table-wrap">
        <table>
          <tr>
  <th>Image</th>
  <th>Name & Description</th>
  <th>Category</th>
  <th>Stock</th>
  <th>Price</th>
  <th>Discount</th>
  <th>Final Price</th>
  <th>Actions</th>
</tr>
          <tbody id="stockTable"></tbody>
        </table>
      </div>`;
    buildCategoryFilter();
    renderProducts();
  }
};
window.goTo = window.goTo;

window.logout = async function(){
  try {
    await signOut(auth);
    // onAuthStateChanged will redirect
  } catch(e){
    console.error(e);
    window.location.href = 'login.html';
  }
};

window.toggleSidebar = function(){ const s = document.getElementById('sidebar'); if(s) s.classList.toggle('active'); };

/* ====== Init: wire up UI initial state ====== */
(function init(){
  // Initially hide imgFile row if present
  try{ toggleImageInput(); }catch(e){}
  // buildCategoryFilter() and renderProducts() will run after realtime listener sets productsSnapshot
})();
</script>
</body>
</html>